From 5b8fd4e0e5f80f62f866a5f02f9e85b9311e0cb6 Mon Sep 17 00:00:00 2001
From: Anton Kikin <a.kikin@tano-systems.com>
Date: Thu, 12 Nov 2020 05:00:34 +0300
Subject: [PATCH 16/24] jail: Add libnss_* libs to mounts when using glibc

Signed-off-by: Anton Kikin <a.kikin@tano-systems.com>
---
 jail/jail.c | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/jail/jail.c b/jail/jail.c
index 09780ac..5cfda2f 100644
--- a/jail/jail.c
+++ b/jail/jail.c
@@ -64,6 +64,10 @@
 #include <libubox/utils.h>
 #include <libubus.h>
 
+#if defined(__GLIBC__)
+#include <glob.h>
+#endif
+
 #ifndef CLONE_NEWCGROUP
 #define CLONE_NEWCGROUP 0x02000000
 #endif
@@ -2920,6 +2924,24 @@ errout:
 	return ret;
 }
 
+#if defined(__GLIBC__)
+static void add_glibc_nss_libs(void)
+{
+	glob_t gl;
+	int i;
+
+	if (glob("/lib/libnss_*.so*", GLOB_NOESCAPE, NULL, &gl)) {
+		ERROR("%s: glob failed\n", __func__);
+		return;
+	}
+
+	for (i = 0; i < gl.gl_pathc; i++)
+		add_mount_bind(gl.gl_pathv[i], 1, -1);
+
+	globfree(&gl);
+}
+#endif
+
 static void post_main(struct uloop_timeout *t)
 {
 	if (apply_rlimits()) {
@@ -2942,7 +2964,10 @@ static void post_main(struct uloop_timeout *t)
 
 #if defined(__GLIBC__)
 			if (!opts.extroot)
+			{
 				add_mount_bind("/etc/nsswitch.conf", 1, -1);
+				add_glibc_nss_libs();
+			}
 #endif
 			if (opts.setns.ns == -1) {
 				if (!(opts.namespace & CLONE_NEWNET)) {
-- 
2.34.1.windows.1


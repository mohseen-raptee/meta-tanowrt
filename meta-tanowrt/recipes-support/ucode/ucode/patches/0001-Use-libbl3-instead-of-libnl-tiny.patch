From b3caec87522bc586b53cfb0b9a1abfd2179af11f Mon Sep 17 00:00:00 2001
From: Anton Kikin <a.kikin@tano-systems.com>
Date: Tue, 15 Feb 2022 16:13:07 +0300
Subject: [PATCH] Use libbl3 instead of libnl-tiny

Signed-off-by: Anton Kikin <a.kikin@tano-systems.com>
---
 CMakeLists.txt | 8 ++++----
 lib/rtnl.c     | 7 +++++--
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 3fb1f7a..df1a357 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -142,9 +142,9 @@ IF(UCI_SUPPORT)
 ENDIF()
 
 IF(RTNL_SUPPORT)
-  FIND_LIBRARY(nl NAMES nl-tiny)
+  FIND_LIBRARY(nl NAMES nl-3)
   FIND_LIBRARY(ubox NAMES ubox)
-  FIND_PATH(nl_include_dir NAMES netlink/msg.h PATH_SUFFIXES libnl-tiny)
+  FIND_PATH(nl_include_dir NAMES netlink/msg.h PATH_SUFFIXES libnl3)
   INCLUDE_DIRECTORIES(${nl_include_dir})
   SET(LIBRARIES ${LIBRARIES} rtnl_lib)
   ADD_LIBRARY(rtnl_lib MODULE lib/rtnl.c)
@@ -154,9 +154,9 @@ IF(RTNL_SUPPORT)
 ENDIF()
 
 IF(NL80211_SUPPORT)
-  FIND_LIBRARY(nl NAMES nl-tiny)
+  FIND_LIBRARY(nl NAMES nl-3)
   FIND_LIBRARY(ubox NAMES ubox)
-  FIND_PATH(nl_include_dir NAMES netlink/msg.h PATH_SUFFIXES libnl-tiny)
+  FIND_PATH(nl_include_dir NAMES netlink/msg.h PATH_SUFFIXES libnl3)
   INCLUDE_DIRECTORIES(${nl_include_dir})
   SET(LIBRARIES ${LIBRARIES} nl80211_lib)
   ADD_LIBRARY(nl80211_lib MODULE lib/nl80211.c)
diff --git a/lib/rtnl.c b/lib/rtnl.c
index 6a9144e..d0a20ca 100644
--- a/lib/rtnl.c
+++ b/lib/rtnl.c
@@ -3367,6 +3367,7 @@ uc_nl_request(uc_vm_t *vm, size_t nargs)
 	struct nl_cb *cb;
 	socklen_t optlen;
 	int enable, err;
+	int s_fd;
 	void *buf;
 	size_t i;
 
@@ -3404,13 +3405,15 @@ uc_nl_request(uc_vm_t *vm, size_t nargs)
 
 	optlen = sizeof(enable);
 
-	if (getsockopt(sock->s_fd, SOL_NETLINK, NETLINK_GET_STRICT_CHK, &enable, &optlen) < 0)
+	s_fd = nl_socket_get_fd(sock);
+	if (getsockopt(s_fd, SOL_NETLINK, NETLINK_GET_STRICT_CHK, &enable, &optlen) < 0)
 		enable = 0;
 
 	if (!!(flagval & NLM_F_STRICT_CHK) != enable) {
 		enable = !!(flagval & NLM_F_STRICT_CHK);
 
-		if (setsockopt(sock->s_fd, SOL_NETLINK, NETLINK_GET_STRICT_CHK, &enable, sizeof(enable)) < 0)
+		s_fd = nl_socket_get_fd(sock);
+		if (setsockopt(s_fd, SOL_NETLINK, NETLINK_GET_STRICT_CHK, &enable, sizeof(enable)) < 0)
 			err_return(nl_syserr2nlerr(errno), "Unable to toggle NETLINK_GET_STRICT_CHK");
 	}
 
-- 
2.34.1.windows.1

